# PicoStitch - 开发与优化日志

这是一个根据用户需求，逐步迭代和优化一个纯前端图片拼接工具的开发记录。

## 初始状态

项目开始时，只有一个 `index.html` 文件，其核心功能是使用HTML5 Canvas合并图片，但存在一些问题和可以改进之处。

## 迭代记录

### 1. 修复边框问题
- **需求**: 解决拼接图片时，图片之间的边框是外部边框两倍的问题（20px vs 10px）。
- **实现**: 修改了 `onCombine` 函数中的绘图逻辑，精确计算坐标，确保所有边框（内部和外部）统一为10px。同时，初步加入了对“纵向”模式的支持。

### 2. 增加边框自定义功能
- **需求**: 允许用户自定义边框的宽度和颜色。
- **实现**:
    - **HTML**: 添加了 `type="number"` 的输入框用于设置边框宽度，以及 `type="color"` 的输入框用于选择颜色。
    - **JavaScript**: 更新了 `onCombine` 函数，使其从新的输入框中获取值来动态设置边框样式。

### 3. UI框架现代化 (Pico.css)
- **背景**: 用户认为默认UI、Bootstrap、Tailwind和Bulma都不甚理想。
- **决策**: 采纳建议，使用 **Pico.css** 框架进行UI改造。
- **实现**:
    - 引入 Pico.css 的CDN链接。
    - 移除所有旧的自定义样式。
    - 使用 Pico.css 的语义化标签（如 `<main>`, `<hgroup>`, `<fieldset>`）和栅格系统重构了整个HTML布局。
    - 修复了迁移过程中因CSS变量名错误导致的拖放区域背景色和文字丢失的问题。
    - 为拖放区域背景增加了30%的透明度，提升了视觉效果。

### 4. 交互体验优化
- **需求 1**: 将文件列表中的“上移/下移”操作按钮做得更清晰、更易用。
- **实现**:
    - 使用 Pico.css 的Button组件替换了原来的文本链接。
    - 将 `<a>` 标签改为更语义化的 `<button>` 元素，并同步更新了事件监听器。

- **需求 2**: 为“质量”范围滑块增加实时数值预览。
- **实现**:
    - **HTML**: 在滑块标签旁添加了一个 `<span>` 用于显示数值。
    - **JavaScript**: 添加了事件监听，在用户拖动滑块时实时更新 `<span>` 的内容。

- **需求 3**: 在文件列表中增加图片预览。
- **实现**:
    - **JavaScript**: 修改 `renderImagesList` 函数，在列表中生成 `<img>` 标签来显示图片。
    - **CSS**: 添加了样式来美化预览图和列表项的布局。

### 5. 核心性能优化
- **问题 1**: 在图片较多时，调整顺序（上移/下移）操作非常卡顿。
- **根源**: 每次移动都重新渲染整个列表，导致包含大量Base64数据的DOM被重复解析。
- **解决方案**: 修改事件监听逻辑，从“重新渲染整个列表”改为“**直接在DOM中移动对应的`<li>`元素**”，并只更新受影响元素的`data-index`。

- **问题 2**: 上传的原始图片文件很大时，预览列表本身就会造成浏览器卡顿和内存占用过高。
- **根源**: 直接将原始大图的Base64 URL用作预览图。
- **解决方案**:
    1.  在 `loadImages` 函数中，为每张上传的图片动态创建**一个最大边长200px的JPEG缩略图**。
    2.  `IMAGES` 数组中同时保存原始大图对象和缩略图的Data URL。
    3.  预览列表 (`renderImagesList`) 只使用轻量级的缩略图。
    4.  最终合并 (`onCombine`) 时，使用存储的原始大图对象进行绘制，保证输出质量。

### 6. 拖拽排序功能
- **需求**: 增加拖拽排序功能，并提供清晰的视觉引导。
- **实现**:
    1.  为列表项添加 `draggable="true"` 属性和拖拽事件监听 (`dragstart`, `dragover`, `drop` 等)。
    2.  解决了拖拽排序与全局的拖拽上传功能的事件冲突。
    3.  根据用户反馈，增加了专门的“拖拽把手”图标，并将拖拽功能严格限制在该把手上，避免误操作。
    4.  修复了限制拖拽把手时引入的逻辑bug。

### 7. 布局与输出质量优化
- **问题 1**: 横向拼接不同比例的图片时，每张图在最终成品中所占空间不一，且上下留白不同，不美观。
- **解决方案**: 引入“**单元格 (Cell)**”布局概念。通过计算和绘制大小统一的单元格背景，再将图片居中绘制于其中，确保了视觉上的对齐。

- **问题 2**: 将拼接好的图片缩放到固定的预设尺寸（如 `2560x1440`）时，会导致图片变形。
- **解决方案**:
    1.  **改进UI**: 将尺寸选项从 `宽x高` 改为更清晰的**单一维度约束**（如 `最大宽度: 2560px`）。
    2.  **改进逻辑**: 将预设尺寸作为“**最大边界框**”，对最终图片进行**等比缩放**，确保其能被完整放入目标框内而绝不变形。
    3.  修复了此项重构中引入的 `TypeError` bug。

### 8. 高级版式控制
- **需求**: 提供更专业的、基于裁剪的对齐模式，以实现绝对的视觉统一。
- **实现**:
    - **新增“统一宽度”模式**: 以所有图片中**最矮**的一张为基准，对其他过高的图片进行上下居中裁剪。
    - **新增“统一高度”模式**: 以所有图片中**最高**的一张为基准，对其他过宽的图片进行左右居中裁剪。
    - **新增“固定尺寸(裁剪填充)”模式**: 允许用户输入最终的目标尺寸（如2560x1440），程序会自动计算单元格大小，并通过缩放和居中裁剪，将每张图片完美填充到其单元格中，最终生成一张尺寸精确、无缝拼接的合成图。
    - **新增“移除外层边框”选项**: 提供一个复选框，允许用户只保留图片之间的边框，移除最外围的一圈边框，实现更自由的版式控制。
    - **修复相关Bug**: 解决了新功能中引入的边框宽度和边框颜色在特定模式下失效的问题。

### 9. 最终完善
- **品牌化**: 为项目正式命名为 **PicoStitch**，并更新到页面标题中。
- **主题切换**: 
    - **UI**: 在页面右上角使用Pico.css的Select组件实现了一个优雅的主题切换器。
    - **功能**: 支持亮色(Light)、暗色(Dark)和自动(Auto)三种模式。
    - **偏好记忆**: 使用 `localStorage` 存储用户的选择，以便在下次访问时自动应用。
    - **修复Bug**: 解决了主题在页面刷新时无法正确应用的初始化时序问题。
- **信息输出**: 在最终结果区域，清晰地显示生成图片的**尺寸（宽x高）**和**文件大小**。

## 最终成果
经过一系列的迭代和优化，这个最初简单的工具，现在已经成为一个功能完善、性能流畅、交互友好且输出专业的现代化Web应用。它不仅提供了基础的图片拼接功能，更具备了多种高级、专业的版式控制选项，可以满足不同场景下的复杂需求。
